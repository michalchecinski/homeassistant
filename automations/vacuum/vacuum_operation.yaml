##########################
#  Vacuum on automation  #
##########################

- id: vacuum_on
  alias: Vacuum start
  trigger:
    - platform: state
      entity_id: input_boolean.michal_home
      to: 'off'
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: input_boolean.michal_home
        state: 'off'
      # vacuum not working already
      - condition: state
        entity_id: vacuum.xiaomi_vacuum_cleaner
        state: 'docked'
      - condition: state
        entity_id: input_boolean.vacation_mode
        state: 'off'
      - condition: state
        entity_id: input_boolean.vacuum_finished
        state: 'off'
      - condition: time
        after: '07:40:00'
        before: '20:00:00'
  action:
    - service: vacuum.start
      data:
        entity_id: vacuum.xiaomi_vacuum_cleaner
    - service: vacuum.set_fan_speed
      data:
        entity_id: vacuum.xiaomi_vacuum_cleaner
        fan_speed: Auto



- id: vacuum_off_notification
  alias: Vacuum stop sb home
  trigger:
    - platform: state
      entity_id: input_boolean.michal_home
      to: 'on'
  condition:
    - condition: state
      entity_id: vacuum.xiaomi_vacuum_cleaner
      state: 'cleaning'
  action:
    - service: notify.mobile_app_michal_galaxy
      data:
        message: "Odkurzacz nie skończył pracy, ale się wyłączył - ktoś jest w domu."
        data:
          actions:
            - action: vacuum_on
              title: Dokończ odkurzanie
    - service: homeassistant.turn_on
      data_template:
        entity_id: script.vacuum_stop


- id: vacuum_finished
  alias: Vacuum finished
  trigger:
    - platform: state
      entity_id: vacuum.xiaomi_vacuum_cleaner
      from: 'returning'
      to: 'docked'
    - platform: state
      entity_id: vacuum.xiaomi_vacuum_cleaner
      from: 'cleaning'
      to: 'docked'
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: '{{ states.vacuum.xiaomi_vacuum_cleaner.attributes.cleaned_area | int >= 30 }}'
      - condition: template
        value_template: '{{ as_timestamp(now()) - as_timestamp(states.automation.vacuum_off.attributes.last_triggered) | int > 40 }}'
  action:
    - service: input_boolean.turn_on
      data_template:
        entity_id: input_boolean.vacuum_finished


- id: vacuum_finished_off
  alias: Vacuum finished input bool to off
  trigger:
    - platform: time
      at: '00:01:00'
  action:
    - service: input_boolean.turn_off
      data_template:
        entity_id: input_boolean.vacuum_finished