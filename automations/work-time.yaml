- id: send_daily_worktime
  alias: Work time - daily send
  trigger:
    - platform: state
      entity_id: person.michal
      to: 'praca'
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: "{{ states.sensor.michal_work_today.state | float < 1 }}"
      - condition: template
        value_template: "{{ states.input_number.michal_work_last_day.state | float != 0.0 }}"
      - condition: time
        weekday:
        - mon
        - tue
        - wed
        - thu
        - fri
  action:
    - service: notify.gmail_notification
      data:
        title: 'Raport z wczorajszej pracy'
        message: 'Wczoraj byłeś w pracy {{ states.input_number.michal_work_last_day.state }} godzin'
    - service: notify.michal_html
      data:
        message: 'Wczoraj byłeś w pracy {{ states.input_number.michal_work_last_day.state }} godzin'
    - delay: '00:00:05'
    - service: input_number.set_value
      data_template:
        entity_id: input_number.michal_work_last_day
        value: "{{ 0.0 | float }}"

- id: send_weekly_worktime
  alias: Work time - weekly send
  trigger:
    - platform: state
      entity_id: person.michal
      to: 'work'
  condition:
    condition: or
    conditions:
      - condition: time
        weekday:
        - mon
      - condition: and
        conditions:
        - condition: template
          value_template: "{{ states.input_number.michal_work_last_week.state | float != 0.0 }}"
        - condition: template
          value_template: "{{ as_timestamp( now() ) - as_timestamp( state_attr('automation.work_time_weekly_send', 'last_triggered') ) | int > 7*86400 }}"
  action:
    - service: notify.gmail_notification
      data:
        title: 'Raport z zeszłotygodniowej pracy'
        message: 'W zeszłym tygodniu byłeś w pracy {{ states.input_number.michal_work_last_week.state }} godzin'
    - delay: '00:00:05'
    - service: input_number.set_value
      data_template:
        entity_id: input_number.michal_work_last_week
        value: "{{ 0.0 | float }}"


- id: send_monthly_worktime
  alias: Work time - monthly send
  trigger:
    - platform: time
      at: '07:30:00'
  condition:
    - condition: template
      value_template: "{{ now().day == 1 }}"
  action:
    - service: notify.gmail_notification
      data:
        title: 'Raport z miesięcznej pracy'
        message: 'W zeszłym miesiącu byłeś w pracy {{ states.input_number.michal_work_last_month.state }} godzin'
    - delay: '00:00:05'
    - service: input_number.set_value
      data_template:
        entity_id: input_number.michal_work_last_month
        value: "{{ 0.0 | float }}"


- id: save_daily_worktime
  alias: Work time - daily save
  trigger:
    - platform: time
      at: '23:55:00'
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: "{{ states.sensor.michal_work_today.state | float != 0.0 }}"
      - condition: time
        weekday:
        - mon
        - tue
        - wed
        - thu
        - fri
  action:
    - service: input_number.set_value
      data_template:
        entity_id: input_number.michal_work_last_day
        value: "{{ states.sensor.michal_work_today.state | float }}"
    - service: input_number.set_value
      data_template:
        entity_id: input_number.michal_work_last_week
        value: "{{ states.input_number.michal_work_last_week.state | float + states.sensor.michal_work_today.state | float }}"
    - service: input_number.set_value
      data_template:
        entity_id: input_number.michal_work_last_month
        value: "{{ states.input_number.michal_work_last_month.state | float + states.sensor.michal_work_today.state | float }}"

- id: time_to_home
  alias: Work notification - time to home
  trigger:
    platform: numeric_state
    entity_id: sensor.michal_work_today
    above: 8
  condition:
    - condition: state
      entity_id: person.michal
      state: 'praca'
  action:
    - service: notify.michal_html
      data:
        message: "Czas wychodzić z pracy. Jesteś tu już 8h"

